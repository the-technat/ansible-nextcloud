---
# Taken from https://github.com/ReinerNippes/nextcloud/blob/master/roles/prep_mariadb/tasks/main.yml
- name: Figure out where to save credentials locally 
  set_fact:
    credential_store: "{{ playbook_dir }}/secrets"
    credential_store_owner: "{{ lookup('env', 'USER') }}"
  when: credential_store == ''
  delegate_to: localhost
- name: Ensure {{ credential_store }} is available
  file: 
    owner: "{{ credential_store_owner }}"
    name: '{{ credential_store }}'
    mode:  0700
    state: directory
  delegate_to: localhost
- name: Generate DB password if nc_db_passwd is empty
  set_fact: 
    nc_db_passwd: "{{ lookup('password', '{{ credential_store }}/database_secret chars=ascii_letters,digits length=32') }}"
  when: nc_db_passwd == ''
- name: Ensure PyMySQL is installed
  pip: 
    name: PyMySQL
    state: latest
- name: Ensure MariaDB is installed
  apt:
    name:
    - mariadb-server
    update_cache: yes
    state: latest
- name: MariaDB Service is enabled and running
  systemd:
    name: mariadb
    enabled: yes
    state: started
- name: MariaDB Config dir exists
  file:
    name: "{{ mariadb_conf_dir | dirname }}"
    owner: root
    group: root
    mode: 0755
    state: directory
- name: MariaDB config is present
  template:
    src: nextcloud.cnf.j2
    dest: "{{ mariadb_conf_dir }}"
    owner: root
    group: root
    mode: 0644
  notify: restart mariadb
- name: Anonymous user is removed
  mysql_user:
    name: ''
    host_all: yes
    state: absent
    login_unix_socket: "{{ mariadb_sock_dir }}/mysqld.sock"
- name: Test DB is removed
  mysql_db:
    name: test
    state: absent
    login_unix_socket: "{{ mariadb_sock_dir }}/mysqld.sock"
- name: Nextcloud DB exists
  mysql_db:
    name: "{{ nc_db }}"
    collation: utf8mb4_general_ci
    encoding: utf8mb4
    login_unix_socket: "{{ mariadb_sock_dir }}/mysqld.sock"
- name: Nextcloud DB user exists
  mysql_user:
    name:     "{{ nc_db_user }}"
    password: "{{ nc_db_passwd }}"
    priv:     "{{ nc_db }}.*:ALL"
    state: present
    login_unix_socket: "{{ mariadb_sock_dir }}/mysqld.sock"